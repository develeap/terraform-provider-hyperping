# Lefthook configuration for terraform-provider-hyperping
# Install: go install github.com/evilmartians/lefthook@latest && lefthook install
# Docs: https://github.com/evilmartians/lefthook

# Pre-commit: Fast checks only (formatting, syntax)
pre-commit:
  parallel: true
  commands:
    go-fmt:
      glob: "*.go"
      run: gofmt -l -w {staged_files}
      stage_fixed: true
    go-mod-tidy:
      run: go mod tidy -diff
      fail_text: "go.mod/go.sum not tidy. Run: go mod tidy"
    generate-docs:
      run: |
        echo "üìù Generating Terraform provider documentation..."

        # Backup manual documentation
        [ -d "docs/guides" ] && cp -r docs/guides /tmp/docs-guides-backup
        [ -f "docs/index.md" ] && cp docs/index.md /tmp/docs-index-backup.md
        [ -f "docs/TROUBLESHOOTING.md" ] && cp docs/TROUBLESHOOTING.md /tmp/docs-troubleshooting-backup.md

        # Generate schema-based documentation
        cd tools && go run github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs generate --provider-dir .. --provider-name hyperping
        cd ..

        # Restore manual documentation
        [ -d "/tmp/docs-guides-backup" ] && cp -r /tmp/docs-guides-backup docs/guides
        [ -f "/tmp/docs-index-backup.md" ] && cp /tmp/docs-index-backup.md docs/index.md
        [ -f "/tmp/docs-troubleshooting-backup.md" ] && cp /tmp/docs-troubleshooting-backup.md docs/TROUBLESHOOTING.md

        # Only stage generated docs (resources, data-sources)
        if ! git diff --exit-code --quiet docs/resources/ docs/data-sources/; then
          git add docs/resources/ docs/data-sources/
          echo "‚úÖ Documentation updated and staged"
        else
          echo "‚úÖ Documentation already up to date"
        fi
      stage_fixed: true
      fail_text: "Failed to generate documentation"

# Pre-push: Full validation before pushing to remote
pre-push:
  parallel: true
  commands:
    build:
      run: go build -v .
      fail_text: "Build failed"

    lint:
      run: golangci-lint run ./...
      fail_text: "Linting failed. Run: golangci-lint run ./..."

    test:
      run: go test ./internal/... -count=1 -race -timeout=5m
      fail_text: "Tests failed"

    vet:
      run: go vet ./...
      fail_text: "go vet found issues"

    govulncheck:
      run: govulncheck ./... || true  # Non-fatal: govulncheck has known issues with some deps
      fail_text: "Vulnerabilities found. Run: govulncheck ./..."

# Skip hooks in CI (GitHub Actions sets CI=true)
skip_in_ci: true
