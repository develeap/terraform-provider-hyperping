# Notification Strategy for API Changes

## Overview

When API changes are detected, we need to notify developers in a way that:
1. ‚úÖ Is **persistent** (not lost in chat logs)
2. ‚úÖ Is **actionable** (clear what needs to be done)
3. ‚úÖ Is **discussable** (can comment and track progress)
4. ‚úÖ Is **searchable** (find historical changes)
5. ‚úÖ Has **right urgency** (breaking changes get immediate attention)

---

## Recommended Multi-Channel Strategy

### üéØ Primary: GitHub Issues (Always)

**Why GitHub Issues?**
- ‚úÖ Persistent record of all API changes
- ‚úÖ Can discuss and assign to team members
- ‚úÖ Trackable with labels (breaking, non-breaking, needs-review)
- ‚úÖ Linkable in PRs and commits
- ‚úÖ Searchable history ("when did parameter X get added?")
- ‚úÖ Can close when provider updated

**Example Issue:**
```markdown
Title: [API Change] New parameter 'test_mode' in POST /v1/monitors

Labels: api-change, non-breaking, monitors-api

## Summary
Parameter-level changes detected in Monitors API

## Changes Detected

### POST /v1/monitors (Create Monitor)

#### üÜï New Parameters
- **test_mode** (boolean, optional)
  - Description: Enable test mode for dry-run testing
  - Default: false
  - Location: Request body

#### üìù Modified Parameters
- **timeout**: Valid values updated
  - Old: [5, 10, 15, 20]
  - New: [5, 10, 15, 20, 30]

## Impact Assessment
- ‚úÖ Non-breaking (all new parameters are optional)
- ‚úÖ Backward compatible
- üìù Provider update recommended to support new fields

## Action Items
- [ ] Review changes
- [ ] Update provider schema (if supporting new fields)
- [ ] Update tests
- [ ] Update documentation

## Links
- API Snapshot: [View Diff](https://github.com/org/repo/blob/api-snapshots/2026-02-03.json)
- Documentation: https://hyperping.com/docs/api/monitors/create

---
ü§ñ Auto-detected by API scraper on 2026-02-03 09:45:30 UTC
```

---

### üîî Secondary: Slack Notifications (Breaking Changes Only)

**When to use:**
- Only for **breaking changes** that need immediate attention
- Team gets real-time alert
- Links to GitHub Issue for details

**Example Slack Message:**
```
‚ö†Ô∏è BREAKING API CHANGE DETECTED

*Endpoint:* POST /v1/monitors
*Change:* Parameter 'url' validation now requires https://

*Impact:* Existing http:// URLs will be rejected
*Action Required:* Update provider validation

üìã View details: https://github.com/org/repo/issues/123
ü§ñ Detected: 2026-02-03 09:45:30 UTC
```

---

### üìß Optional: Email Notifications (Digest)

**When to use:**
- Weekly digest of all API changes
- Good for stakeholders who don't actively monitor GitHub

**Example Email:**
```
Subject: Hyperping API Changes - Week of Feb 3-10, 2026

3 API changes detected this week:

1. [Non-breaking] New 'test_mode' parameter in Monitors API
   https://github.com/org/repo/issues/123

2. [Non-breaking] New timeout value (30s) supported
   https://github.com/org/repo/issues/124

3. [Breaking] Status Pages API now requires https:// URLs
   https://github.com/org/repo/issues/125
   ‚ö†Ô∏è Action required by Feb 15

View all changes: https://github.com/org/repo/labels/api-change
```

---

### üîÑ Bonus: Automated Pull Requests (Non-Breaking)

**When to use:**
- For non-breaking additive changes
- Auto-generate PR to update provider
- Saves manual work

**Example PR:**
```markdown
Title: feat: add test_mode parameter to monitor creation

## Auto-Generated Changes

This PR adds support for new optional parameters detected in the Hyperping API:

### Changes
- Add `test_mode` field to `MonitorResourceModel`
- Add schema definition with validation
- Update tests to cover new field

### API Change Reference
- Issue: #123
- Non-breaking: ‚úÖ All new fields are optional
- Snapshot: [View API docs](link)

### Testing
- [ ] Unit tests pass
- [ ] Acceptance tests pass
- [ ] Manual testing with test_mode=true
- [ ] Manual testing with test_mode=false (default)

---
ü§ñ Auto-generated by API scraper
```

---

## Implementation in GitHub Workflow

### Workflow File Structure

```yaml
name: Scrape Hyperping API Documentation

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  scrape-and-diff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run scraper
        id: scrape
        run: |
          cd tools/scraper
          go run scraper.go

          # Outputs: has_changes, breaking, added_params, removed_params
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "breaking=false" >> $GITHUB_OUTPUT
          echo "changes_summary=New parameter: test_mode" >> $GITHUB_OUTPUT

      - name: Commit API snapshot to orphan branch
        if: steps.scrape.outputs.has_changes == 'true'
        run: |
          git checkout --orphan api-snapshots || git checkout api-snapshots
          git add snapshots/
          git commit -m "API snapshot $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push --force origin api-snapshots

      - name: Generate diff report
        if: steps.scrape.outputs.has_changes == 'true'
        id: diff
        run: |
          cd tools/scraper
          go run differ.go > diff-report.md
          cat diff-report.md

      - name: Create GitHub Issue
        if: steps.scrape.outputs.has_changes == 'true'
        uses: dacbd/create-issue-action@main
        id: create_issue
        with:
          token: ${{ github.token }}
          title: "[API Change] ${{ steps.scrape.outputs.changes_summary }}"
          body-path: tools/scraper/diff-report.md
          labels: |
            api-change
            automated
            ${{ steps.scrape.outputs.breaking == 'true' && 'breaking-change' || 'non-breaking' }}
          assignees: ${{ github.repository_owner }}

      - name: Send Slack notification (breaking only)
        if: steps.scrape.outputs.has_changes == 'true' && steps.scrape.outputs.breaking == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è BREAKING API CHANGE",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Breaking change detected in Hyperping API*\n\n${{ steps.scrape.outputs.changes_summary }}\n\n<${{ github.server_url }}/${{ github.repository }}/issues/${{ steps.create_issue.outputs.number }}|View Issue #${{ steps.create_issue.outputs.number }}>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ü§ñ Detected: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create PR for non-breaking changes
        if: steps.scrape.outputs.has_changes == 'true' && steps.scrape.outputs.breaking == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "feat: support new API parameters"
          title: "feat: add support for new Hyperping API fields"
          body: |
            ## Auto-Generated Provider Update

            This PR adds support for new optional parameters detected in the Hyperping API.

            **Related Issue**: #${{ steps.create_issue.outputs.number }}
            **Breaking**: No ‚úÖ

            ### Changes
            ${{ steps.scrape.outputs.changes_summary }}

            ### Testing Required
            - [ ] Review changes in issue #${{ steps.create_issue.outputs.number }}
            - [ ] Run acceptance tests
            - [ ] Manual testing if needed

            ---
            ü§ñ Auto-generated by API scraper
          branch: api-update-${{ github.run_id }}
          labels: api-change,automated,non-breaking
```

---

## GitHub Issue Templates

### Template: API Change Issue

Location: `.github/ISSUE_TEMPLATE/api_change.md`

```markdown
---
name: API Change Detection
about: Automatically created when API changes are detected
title: '[API Change] '
labels: api-change, automated
assignees: ''
---

## Summary
<!-- Auto-filled by scraper -->

## Changes Detected

### Endpoint: <!-- e.g., POST /v1/monitors -->

#### üÜï New Parameters
<!-- List of new parameters -->

#### üìù Modified Parameters
<!-- List of modified parameters with old vs new -->

#### ‚ùå Removed Parameters
<!-- List of removed parameters -->

## Impact Assessment
<!-- Breaking vs non-breaking analysis -->

## Action Items
- [ ] Review changes
- [ ] Update provider schema
- [ ] Update tests
- [ ] Update documentation
- [ ] Verify backward compatibility

## Links
- API Snapshot: <!-- Link to snapshot -->
- Documentation: <!-- Link to Hyperping docs -->

---
ü§ñ Auto-detected on <!-- timestamp -->
```

---

## Label Strategy

### Required Labels

| Label | Usage | Color |
|-------|-------|-------|
| `api-change` | All API changes | `#0E8A16` (green) |
| `breaking-change` | Breaking changes | `#D93F0B` (red) |
| `non-breaking` | Safe changes | `#0E8A16` (green) |
| `automated` | Auto-created | `#FBCA04` (yellow) |
| `needs-review` | Requires human review | `#D93F0B` (red) |
| `monitors-api` | Monitors endpoint | `#1D76DB` (blue) |
| `statuspages-api` | Status Pages endpoint | `#1D76DB` (blue) |
| `incidents-api` | Incidents endpoint | `#1D76DB` (blue) |

### Setup Labels (GitHub CLI)

```bash
# Create labels
gh label create "api-change" --color "0E8A16" --description "API documentation change detected"
gh label create "breaking-change" --color "D93F0B" --description "Breaking API change"
gh label create "non-breaking" --color "0E8A16" --description "Non-breaking API change"
gh label create "automated" --color "FBCA04" --description "Auto-generated"
gh label create "needs-review" --color "D93F0B" --description "Requires human review"

# Per-API labels
gh label create "monitors-api" --color "1D76DB" --description "Monitors API"
gh label create "statuspages-api" --color "1D76DB" --description "Status Pages API"
gh label create "incidents-api" --color "1D76DB" --description "Incidents API"
# ... etc
```

---

## Notification Frequency & Batching

### Strategy: Smart Batching

Instead of creating an issue for EVERY scrape:

```
‚ùå BAD: Scrape every 6 hours, create issue every time
   ‚Üí 4 issues per day with "No changes"

‚úÖ GOOD: Only create issue when changes detected
   ‚Üí 0-2 issues per week (real changes only)

‚úÖ BETTER: Batch multiple changes in one issue
   ‚Üí 1 weekly summary issue if multiple changes
```

### Implementation

```go
type ChangesBatch struct {
    StartDate   time.Time
    EndDate     time.Time
    Changes     []APIChange
    Breaking    bool
}

// Batch changes over 24 hours
if changes.Count > 0 {
    if changes.Count == 1 {
        // Single change: immediate issue
        createIssue(changes[0])
    } else if changes.Count <= 5 {
        // Multiple changes: batched issue
        createBatchedIssue(changes)
    } else {
        // Many changes: something's wrong, needs review
        createReviewIssue(changes)
    }
}
```

---

## Slack Integration Setup

### Option 1: Incoming Webhook (Simple)

```bash
# 1. Create Slack App: https://api.slack.com/apps
# 2. Enable Incoming Webhooks
# 3. Add webhook to channel
# 4. Copy webhook URL
# 5. Add to GitHub secrets:
gh secret set SLACK_WEBHOOK_URL --body "https://hooks.slack.com/services/..."
```

### Option 2: GitHub-Slack App (Native)

```bash
# 1. Install GitHub app in Slack workspace
# 2. /github subscribe owner/repo issues
# 3. /github subscribe owner/repo label:"breaking-change"
# 4. Automatic notifications to channel
```

**Recommended**: Option 2 (GitHub-Slack app) because:
- ‚úÖ Native integration
- ‚úÖ Rich formatting
- ‚úÖ Thread discussions
- ‚úÖ No webhook management

---

## Testing the Notification Flow

### Test Script

```bash
#!/bin/bash
# test_notifications.sh

echo "üß™ Testing notification flow..."

# 1. Simulate API change
echo "1Ô∏è‚É£ Simulating API change..."
cd tools/scraper
go run test_change.go

# 2. Run diff detector
echo "2Ô∏è‚É£ Running diff detector..."
go run differ.go > diff-report.md

# 3. Create test issue (with [TEST] prefix)
echo "3Ô∏è‚É£ Creating test GitHub issue..."
gh issue create \
  --title "[TEST] API Change - New parameter test_mode" \
  --body-file diff-report.md \
  --label "api-change,non-breaking,automated"

# 4. Send test Slack notification (if breaking)
echo "4Ô∏è‚É£ Sending test Slack notification..."
curl -X POST $SLACK_WEBHOOK_URL \
  -H 'Content-Type: application/json' \
  -d '{
    "text": "‚ö†Ô∏è [TEST] BREAKING API CHANGE",
    "blocks": [{
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Test notification*\n\nThis is a test of the breaking change notification system."
      }
    }]
  }'

echo "‚úÖ Test complete! Check GitHub Issues and Slack channel."
```

---

## Summary: Recommended Setup

### Tier 1 (Essential) - Implement in Plan A
1. ‚úÖ **GitHub Issues** - Always create for any API change
2. ‚úÖ **Labels** - Classify changes (breaking/non-breaking, per-API)
3. ‚úÖ **Orphan branch** - Store API snapshots

### Tier 2 (Highly Recommended) - Add after Plan A
4. ‚úÖ **Slack notifications** - Breaking changes only
5. ‚úÖ **Automated PRs** - Non-breaking changes

### Tier 3 (Nice to Have) - Future
6. ‚úÖ **Email digests** - Weekly summaries
7. ‚úÖ **Metrics dashboard** - Track API stability over time

---

## Decision for Plan A

**Question**: Which notification channels to implement?

**Option 1**: GitHub Issues only (simplest)
- Create issue on every change
- Labels for classification
- **Time**: Included in Plan A (no extra work)

**Option 2**: GitHub Issues + Slack (recommended)
- Issues for all changes
- Slack for breaking changes
- **Time**: +4 hours for Slack integration

**Option 3**: Full stack (Issues + Slack + PRs)
- Issues for all
- Slack for breaking
- Auto-PRs for non-breaking
- **Time**: +1 day for PR automation

**My recommendation**: **Option 2** (Issues + Slack)
- Most value for minimal extra work
- Slack alerts ensure breaking changes don't go unnoticed
- Can add PR automation later if useful
