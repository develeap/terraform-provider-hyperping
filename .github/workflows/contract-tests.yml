name: Contract Tests

# Run daily at 2 AM UTC to discover API changes via live contract testing
# This is a discovery job - it reports findings but does NOT block builds
on:
  # Include push/pull_request to register workflow, but jobs are skipped via check-trigger
  push:
    branches: [main]
  pull_request:
    branches: [main]

  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC

  # Allow manual trigger for ad-hoc testing
  workflow_dispatch:
    inputs:
      mode:
        description: 'Test mode'
        required: false
        default: 'replay'
        type: choice
        options:
          - replay
          - record

permissions:
  contents: read
  issues: write

jobs:
  # Prevent "No jobs were run" warnings
  check-trigger:
    name: Check Trigger
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check event type
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  contract-tests:
    name: Contract Tests
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run contract tests (replay mode)
        if: github.event.inputs.mode != 'record'
        run: |
          set -o pipefail
          echo "Running contract tests in replay mode"
          go test -v -tags=contract ./internal/client/... \
            -run "TestContract" | tee contract_tests.log
          echo "EXIT_CODE=$?" >> $GITHUB_ENV

      - name: Run contract tests (record mode)
        if: github.event.inputs.mode == 'record'
        env:
          HYPERPING_API_KEY: ${{ secrets.HYPERPING_API_KEY_CONTRACT }}
          VCR_MODE: record
        run: |
          set -o pipefail
          echo "Running contract tests in record mode"
          if [ -z "$HYPERPING_API_KEY" ]; then
            echo "ERROR: HYPERPING_API_KEY_CONTRACT secret not set"
            exit 1
          fi
          go test -v -tags=contract ./internal/client/... \
            -run "TestLiveContract" | tee contract_tests.log
          echo "EXIT_CODE=$?" >> $GITHUB_ENV

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contract-test-logs-${{ github.run_id }}
          path: contract_tests.log
          retention-days: 30

      - name: Analyze test results
        if: always()
        run: |
          MODE="${{ github.event.inputs.mode }}"
          MODE="${MODE:-replay}"

          echo "## Contract Test Results" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${MODE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f contract_tests.log ]; then
            PASS_COUNT=$(grep -c "^--- PASS:" contract_tests.log || true)
            FAIL_COUNT=$(grep -c "^--- FAIL:" contract_tests.log || true)
            SKIP_COUNT=$(grep -c "^--- SKIP:" contract_tests.log || true)

            echo "| Result | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASS_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAIL_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Skipped | $SKIP_COUNT |" >> $GITHUB_STEP_SUMMARY

            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A5 "^--- FAIL:" contract_tests.log | head -50 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test log found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failures
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let logContent = '';
            try {
              logContent = fs.readFileSync('contract_tests.log', 'utf8');
            } catch {
              logContent = 'No test log available';
            }

            const failures = logContent.match(/--- FAIL:[\s\S]*?(?=--- |$)/g) || [];
            const failureText = failures.slice(0, 5).join('\n\n');

            const runNumber = context.runNumber;
            const runId = context.runId;
            const repo = `${context.repo.owner}/${context.repo.repo}`;
            const serverUrl = 'https://github.com';

            const title = `[Contract Tests] API drift detected - ${new Date().toISOString().split('T')[0]}`;

            const body = `## Contract Test Failures

**Run:** [#${runNumber}](${serverUrl}/${repo}/actions/runs/${runId})
**Date:** ${new Date().toISOString()}

### Description
Daily contract tests detected potential API drift.

### Failed Tests
\`\`\`
${failureText || 'See workflow logs for details'}
\`\`\`

### Action Required
1. Review failures
2. Record new cassettes if API changed
3. Investigate replay vs record mismatch

### Links
- [Run](${serverUrl}/${repo}/actions/runs/${runId})
`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'contract-tests,automated',
              per_page: 1
            });

            if (issues.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `New failures detected in run #${runNumber}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['contract-tests', 'automated', 'api-drift']
              });
            }

      - name: Final status (never fails CI)
        if: always()
        run: |
          echo "Contract tests completed."
          echo "Exit code: ${EXIT_CODE:-unknown}"
          exit 0
