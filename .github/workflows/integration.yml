# Integration Tests Workflow for Migration Tools
name: Integration Tests

on:
  push:
    branches:
      - main
    paths:
      - 'cmd/migrate-**/**'
      - 'test/integration/**'
      - '.github/workflows/integration.yml'
  pull_request:
    paths:
      - 'cmd/migrate-**/**'
      - 'test/integration/**'
      - '.github/workflows/integration.yml'
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Test scenario to run (small/medium/large/all)'
        required: false
        default: 'small'
        type: choice
        options:
          - small
          - medium
          - large
          - all

permissions:
  contents: read

jobs:
  integration-betterstack:
    name: 'Integration: Better Stack'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run on: manual trigger, main branch, or PRs from same repo (not forks)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)

    env:
      HAS_BETTERSTACK_CREDS: ${{ secrets.BETTERSTACK_API_TOKEN != '' && secrets.HYPERPING_TEST_API_KEY != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: '1.8.*'
          terraform_wrapper: false

      - name: Run Better Stack integration tests
        if: env.HAS_BETTERSTACK_CREDS == 'true'
        env:
          BETTERSTACK_API_TOKEN: ${{ secrets.BETTERSTACK_API_TOKEN }}
          HYPERPING_API_KEY: ${{ secrets.HYPERPING_TEST_API_KEY }}
          # Use env var to avoid direct interpolation of user input into shell (injection prevention)
          SCENARIO_INPUT: ${{ github.event.inputs.scenario }}
        run: |
          echo "Running Better Stack integration tests..."

          # Validate and map scenario to test pattern (prevents shell injection)
          TEST_PATTERN="."
          case "$SCENARIO_INPUT" in
            small)  TEST_PATTERN="SmallScenario" ;;
            medium) TEST_PATTERN="MediumScenario" ;;
            large)  TEST_PATTERN="LargeScenario" ;;
            all|"") ;;
            *) echo "Invalid scenario: $SCENARIO_INPUT"; exit 1 ;;
          esac

          go test -v -tags=integration -timeout=30m \
            -run="TestBetterStack.*$TEST_PATTERN" \
            ./cmd/migrate-betterstack/

      - name: Skip notice (missing credentials)
        if: env.HAS_BETTERSTACK_CREDS != 'true'
        run: |
          echo "Skipping Better Stack integration tests - credentials not configured"
          echo "This is expected for pull requests from forks."

  integration-uptimerobot:
    name: 'Integration: UptimeRobot'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run on: manual trigger, main branch, or PRs from same repo (not forks)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)

    env:
      HAS_UPTIMEROBOT_CREDS: ${{ secrets.UPTIMEROBOT_API_KEY != '' && secrets.HYPERPING_TEST_API_KEY != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: '1.8.*'
          terraform_wrapper: false

      - name: Run UptimeRobot integration tests
        if: env.HAS_UPTIMEROBOT_CREDS == 'true'
        env:
          UPTIMEROBOT_API_KEY: ${{ secrets.UPTIMEROBOT_API_KEY }}
          HYPERPING_API_KEY: ${{ secrets.HYPERPING_TEST_API_KEY }}
          # Use env var to avoid direct interpolation of user input into shell (injection prevention)
          SCENARIO_INPUT: ${{ github.event.inputs.scenario }}
        run: |
          echo "Running UptimeRobot integration tests..."

          # Validate and map scenario to test pattern (prevents shell injection)
          TEST_PATTERN="."
          case "$SCENARIO_INPUT" in
            small)  TEST_PATTERN="SmallScenario" ;;
            medium) TEST_PATTERN="MediumScenario" ;;
            large)  TEST_PATTERN="LargeScenario" ;;
            all|"") ;;
            *) echo "Invalid scenario: $SCENARIO_INPUT"; exit 1 ;;
          esac

          go test -v -tags=integration -timeout=30m \
            -run="TestUptimeRobot.*$TEST_PATTERN" \
            ./cmd/migrate-uptimerobot/

      - name: Skip notice (missing credentials)
        if: env.HAS_UPTIMEROBOT_CREDS != 'true'
        run: |
          echo "Skipping UptimeRobot integration tests - credentials not configured"
          echo "This is expected for pull requests from forks."

  integration-pingdom:
    name: 'Integration: Pingdom'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run on: manual trigger, main branch, or PRs from same repo (not forks)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)

    env:
      HAS_PINGDOM_CREDS: ${{ secrets.PINGDOM_API_KEY != '' && secrets.HYPERPING_TEST_API_KEY != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: '1.8.*'
          terraform_wrapper: false

      - name: Run Pingdom integration tests
        if: env.HAS_PINGDOM_CREDS == 'true'
        env:
          PINGDOM_API_KEY: ${{ secrets.PINGDOM_API_KEY }}
          HYPERPING_API_KEY: ${{ secrets.HYPERPING_TEST_API_KEY }}
          # Use env var to avoid direct interpolation of user input into shell (injection prevention)
          SCENARIO_INPUT: ${{ github.event.inputs.scenario }}
        run: |
          echo "Running Pingdom integration tests..."

          # Validate and map scenario to test pattern (prevents shell injection)
          TEST_PATTERN="."
          case "$SCENARIO_INPUT" in
            small)  TEST_PATTERN="SmallScenario" ;;
            medium) TEST_PATTERN="MediumScenario" ;;
            large)  TEST_PATTERN="LargeScenario" ;;
            all|"") ;;
            *) echo "Invalid scenario: $SCENARIO_INPUT"; exit 1 ;;
          esac

          go test -v -tags=integration -timeout=30m \
            -run="TestPingdom.*$TEST_PATTERN" \
            ./cmd/migrate-pingdom/

      - name: Skip notice (missing credentials)
        if: env.HAS_PINGDOM_CREDS != 'true'
        run: |
          echo "Skipping Pingdom integration tests - credentials not configured"
          echo "This is expected for pull requests from forks."

  integration-summary:
    name: 'Integration Tests Summary'
    runs-on: ubuntu-latest
    needs: [integration-betterstack, integration-uptimerobot, integration-pingdom]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "=== Integration Tests Summary ==="
          echo ""
          echo "Better Stack: ${{ needs.integration-betterstack.result }}"
          echo "UptimeRobot: ${{ needs.integration-uptimerobot.result }}"
          echo "Pingdom: ${{ needs.integration-pingdom.result }}"
          echo ""

          # Fail if any job failed or was cancelled (allow skipped)
          if [ "${{ needs.integration-betterstack.result }}" = "failure" ] || \
             [ "${{ needs.integration-betterstack.result }}" = "cancelled" ] || \
             [ "${{ needs.integration-uptimerobot.result }}" = "failure" ] || \
             [ "${{ needs.integration-uptimerobot.result }}" = "cancelled" ] || \
             [ "${{ needs.integration-pingdom.result }}" = "failure" ] || \
             [ "${{ needs.integration-pingdom.result }}" = "cancelled" ]; then
            echo "❌ One or more integration test jobs failed or were cancelled"
            exit 1
          fi

          echo "✅ All integration tests passed or were skipped"
