name: API Drift Detection

on:
  schedule:
    # Run every Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  drift:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write        # to commit OAS snapshot branches
      issues: write          # to open/update drift issues
      pull-requests: write   # to open snapshot update PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod   # root module (Go 1.24) — needed to build provider binary
          cache-dependency-path: |
            go.sum
            tools/cmd/scraper/go.sum

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: '~1.8'
          terraform_wrapper: false   # prevents ::error:: annotations from polluting schema stdout

      - name: Restore snapshots cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            tools/cmd/scraper/.scraper_cache.json
            tools/cmd/scraper/snapshots/
          key: scraper-snapshots-${{ github.sha }}
          restore-keys: |
            scraper-snapshots-

      - name: Build scraper
        working-directory: tools/cmd/scraper
        run: go build -o scraper .

      - name: Scrape Hyperping API docs
        working-directory: tools/cmd/scraper
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO_NAME: ${{ github.event.repository.name }}
          CHROME_BIN: google-chrome-stable   # use pre-installed Chrome on ubuntu-latest
        run: |
          ./scraper -snapshot-dir=./snapshots
          echo "SCRAPE_EXIT=$?" >> "$GITHUB_ENV"

      - name: Generate Terraform provider schema
        run: |
          # Build the provider binary from source — avoids registry download and
          # the terraform_wrapper ::error:: stdout-pollution that corrupts schema.json.
          go build -o /tmp/terraform-provider-hyperping .

          # Configure dev_overrides so 'providers schema' uses the local binary.
          # No 'terraform init' is needed or safe with dev_overrides.
          cat > ~/.terraformrc <<'EOF'
          provider_installation {
            dev_overrides {
              "develeap/hyperping" = "/tmp"
            }
            direct {}
          }
          EOF

          # Extract schema; stderr (dev_overrides warning) is silenced.
          if terraform -chdir=examples/complete providers schema -json \
              > /tmp/schema.json 2>/tmp/tf-schema-err; then
            if python3 -c "import json,sys; json.load(open('/tmp/schema.json'))" 2>/dev/null; then
              echo "SCHEMA_AVAILABLE=true" >> "$GITHUB_ENV"
              echo "✅ Schema generated ($(wc -c < /tmp/schema.json) bytes)"
            else
              echo "SCHEMA_AVAILABLE=false" >> "$GITHUB_ENV"
              echo "⚠️ Schema JSON is invalid — coverage will be skipped"
              head -3 /tmp/schema.json || true
            fi
          else
            echo "SCHEMA_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "⚠️ Could not generate provider schema — coverage will be skipped"
            cat /tmp/tf-schema-err || true
          fi

      - name: Run coverage analysis
        if: env.SCHEMA_AVAILABLE == 'true'
        working-directory: tools/cmd/scraper
        run: |
          ./scraper -analyze \
            -schema-file=/tmp/schema.json \
            -snapshot-dir=./snapshots \
            2>&1 | tee coverage.log || true

      - name: Sync check (exit 1 if coverage < 80%)
        if: env.SCHEMA_AVAILABLE == 'true'
        working-directory: tools/cmd/scraper
        run: |
          ./scraper -sync \
            -schema-file=/tmp/schema.json \
            -snapshot-dir=./snapshots

      - name: Commit updated OpenAPI snapshots
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add tools/cmd/scraper/snapshots/ tools/cmd/scraper/docs_scraped/ || true
          if git diff --cached --quiet; then
            echo "No OAS changes to commit."
          else
            BRANCH="chore/oas-snapshots-$(date +%Y%m%d)"
            git checkout -b "$BRANCH"
            git commit -m "chore(scraper): update OpenAPI snapshots [skip ci]"
            git push origin "$BRANCH"
            gh pr create \
              --title "chore(scraper): update OpenAPI snapshots $(date +%Y-%m-%d)" \
              --body "Automated update of OpenAPI snapshots from weekly API drift detection." \
              --base main \
              --head "$BRANCH" || echo "PR creation skipped (may already exist)"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5 # v6.0.0
        with:
          name: coverage-report-${{ github.run_id }}
          path: tools/cmd/scraper/coverage_report*.md
          retention-days: 90
          if-no-files-found: ignore

      - name: Post job summary
        if: always()
        run: |
          echo "## API Drift Detection Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Date | $(date -u +"%Y-%m-%d %H:%M UTC") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Scraper exit | ${SCRAPE_EXIT:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Schema generated | ${SCHEMA_AVAILABLE:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          REPORT=$(ls tools/cmd/scraper/coverage_report_*.md 2>/dev/null | sort | tail -1)
          if [ -n "$REPORT" ]; then
            echo "### Coverage Report" >> "$GITHUB_STEP_SUMMARY"
            cat "$REPORT" >> "$GITHUB_STEP_SUMMARY"
          fi
