name: API Documentation Scraper

on:
  # Run twice daily at 2 AM and 2 PM UTC
  schedule:
    - cron: '0 2 * * *'
    - cron: '0 14 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: false
        default: 'scrape-and-analyze'
        type: choice
        options:
          - scrape-and-analyze
          - scrape-only
          - analyze-only
      log_level:
        description: 'Log level'
        required: false
        default: 'info'
        type: choice
        options:
          - debug
          - info
          - warn
          - error

permissions:
  contents: read
  issues: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    # Skip scraping if analyze-only mode
    if: ${{ github.event.inputs.mode != 'analyze-only' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Full history for proper caching

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'tools/cmd/scraper/go.mod'
          cache-dependency-path: tools/cmd/scraper/go.sum

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          chromium-browser --version

      - name: Restore cache and snapshots
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            tools/cmd/scraper/.scraper_cache.json
            tools/cmd/scraper/snapshots/
            tools/cmd/scraper/docs_scraped/
          key: scraper-data-${{ github.run_id }}
          restore-keys: |
            scraper-data-

      - name: Build scraper
        working-directory: tools/cmd/scraper
        run: go build -o scraper

      - name: Run scraper
        working-directory: tools/cmd/scraper
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          LOG_FORMAT: json
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
        run: |
          ./scraper 2>&1 | tee scraper.log
          echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV

      - name: Upload scraper logs
        if: always()
        uses: actions/upload-artifact@615b319bd27bb32c3d64dca6b6ed6974d5fbe653 # v6.0.0
        with:
          name: scraper-logs-${{ github.run_number }}
          path: tools/cmd/scraper/scraper.log
          retention-days: 30

      - name: Upload diff reports
        if: always()
        uses: actions/upload-artifact@615b319bd27bb32c3d64dca6b6ed6974d5fbe653 # v6.0.0
        with:
          name: diff-reports-${{ github.run_number }}
          path: tools/cmd/scraper/api_changes_*.md
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload scraped data
        if: success()
        uses: actions/upload-artifact@615b319bd27bb32c3d64dca6b6ed6974d5fbe653 # v6.0.0
        with:
          name: scraped-data-${{ github.run_number }}
          path: tools/cmd/scraper/docs_scraped/
          retention-days: 7

      - name: Check for failures
        if: env.EXIT_CODE != '0'
        run: |
          echo "Scraper failed with exit code $EXIT_CODE"
          exit 1

      - name: Post summary
        if: always()
        run: |
          cd tools/cmd/scraper

          echo "## Scraper Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Exit Code:** ${EXIT_CODE:-unknown}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract metrics from log (if available)
          if [ -f scraper.log ]; then
            echo "### Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "(Scraped|Skipped|Failed|Duration|Cache)" scraper.log | head -20 >> $GITHUB_STEP_SUMMARY || echo "No metrics found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # List diff reports
          if ls api_changes_*.md 1> /dev/null 2>&1; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for file in api_changes_*.md; do
              echo "- [$file](../artifacts/${{ github.run_number }}/diff-reports-${{ github.run_number }}/$file)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ No API changes detected" >> $GITHUB_STEP_SUMMARY
          fi

  analyze:
    runs-on: ubuntu-latest
    needs: [scrape]
    # Run if scrape succeeded, or if analyze-only mode (skip dependency)
    if: ${{ always() && (needs.scrape.result == 'success' || github.event.inputs.mode == 'analyze-only') && github.event.inputs.mode != 'scrape-only' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'tools/cmd/scraper/go.mod'
          cache-dependency-path: tools/cmd/scraper/go.sum

      - name: Restore snapshots from cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            tools/cmd/scraper/.scraper_cache.json
            tools/cmd/scraper/snapshots/
            tools/cmd/scraper/docs_scraped/
          key: scraper-data-${{ github.run_id }}
          restore-keys: |
            scraper-data-

      - name: Build scraper
        working-directory: tools/cmd/scraper
        run: go build -o scraper

      - name: Run coverage analysis
        working-directory: tools/cmd/scraper
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
        run: |
          # schema-file is optional; skip coverage analysis if not present.
          if [ -f schema.json ]; then
            ./scraper -analyze -schema-file=./schema.json -snapshot-dir=./snapshots \
              2>&1 | tee analyze.log
          else
            echo "schema.json not found — skipping coverage analysis (run terraform providers schema -json > schema.json first)" | tee analyze.log
          fi
          exit 0

      - name: Upload analysis logs
        if: always()
        uses: actions/upload-artifact@615b319bd27bb32c3d64dca6b6ed6974d5fbe653 # v6.0.0
        with:
          name: analysis-logs-${{ github.run_number }}
          path: tools/cmd/scraper/analyze.log
          retention-days: 30

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@615b319bd27bb32c3d64dca6b6ed6974d5fbe653 # v6.0.0
        with:
          name: coverage-report-${{ github.run_number }}
          path: tools/cmd/scraper/coverage_report*.md
          retention-days: 90
          if-no-files-found: ignore

      - name: Post analysis summary
        if: always()
        run: |
          cd tools/cmd/scraper

          echo "## Coverage Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Include coverage report if available (find latest)
          REPORT=$(ls -t coverage_report_*.md 2>/dev/null | head -1)
          if [ -n "$REPORT" ]; then
            cat "$REPORT" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No coverage report generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the analysis logs for details." >> $GITHUB_STEP_SUMMARY
          fi
