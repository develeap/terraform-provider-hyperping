# Terraform Provider testing workflow.
name: Tests

# This GitHub action runs your tests for each pull request and push.
# Optionally, you can turn it on using a schedule for regular testing.
on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'examples/**'
      - '*.md'
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'examples/**'
      - '*.md'

# Testing only needs permissions to read the repository contents.
permissions:
  contents: read

jobs:
  # Ensure project builds before running testing matrix
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go mod download
      - run: go build -v .
      - name: Run linters
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: v2.10.1
          # Enable caching for faster builds (replaces deprecated skip-pkg-cache/skip-build-cache)
          skip-cache: false
          skip-save-cache: false

  # Documentation check: Verify docs are up-to-date (generated via lefthook pre-commit)
  generate:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_wrapper: false
      - name: Verify documentation is up-to-date
        run: |
          echo "ðŸ” Checking if documentation is up-to-date..."
          cd tools && go run github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs generate --provider-dir .. --provider-name hyperping
          cd ..

          if ! git diff --exit-code --quiet docs/resources/ docs/data-sources/; then
            echo "âŒ Documentation is out of date!"
            echo ""
            echo "The following files have changes:"
            git diff --name-only docs/resources/ docs/data-sources/
            echo ""
            echo "Please run 'lefthook run pre-commit' locally to regenerate docs and commit the changes."
            exit 1
          else
            echo "âœ… Documentation is up-to-date"
          fi

  # Security scanning with SARIF upload to GitHub Security tab
  security:
    name: Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run govulncheck
        run: govulncheck ./...
        continue-on-error: true  # Don't fail build for stdlib vulnerabilities we can't control
      - name: Run gosec
        uses: securego/gosec@398ad549bbf1a51dc978fd966169f660c59774de # v2.23.0
        with:
          args: -no-fail -exclude-generated -exclude-dir=tools -fmt sarif -out gosec-results.sarif ./...
      - name: Upload gosec results to GitHub Security
        uses: github/codeql-action/upload-sarif@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1
        if: always()
        with:
          sarif_file: gosec-results.sarif

  # Run ALL tests: unit, contract, and acceptance tests
  # Optimized with parallel execution and smart caching
  test-suite:
    name: 'All Tests: Terraform ${{ matrix.terraform }}'
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Increased for acceptance tests
    strategy:
      fail-fast: false
      matrix:
        # Test with multiple Terraform versions
        terraform:
          - '1.7.*'
          - '1.8.*'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
          cache-dependency-path: |
            go.sum
            tools/go.sum

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ matrix.terraform }}
          terraform_wrapper: false

      # Cache VCR cassettes for faster test execution
      - name: Cache VCR cassettes
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: internal/client/testdata/cassettes
          key: vcr-cassettes-${{ hashFiles('internal/client/testdata/cassettes/**') }}
          restore-keys: |
            vcr-cassettes-

      - run: go mod download

      # Run unit tests + contract tests with parallel execution
      - name: Run unit & contract tests with coverage
        run: |
          # Parallel execution: -p 4 packages, -parallel 10 tests per package
          go test -v -race -p 4 -parallel 10 \
            -coverprofile=coverage.out -covermode=atomic \
            ./internal/...

          # Exclude test infrastructure from coverage calculation
          # These files are test helpers, not production code that needs testing
          echo "Filtering out test infrastructure from coverage..."
          grep -v "contract_validators.go" coverage.out | \
          grep -v "contract_test_helpers.go" | \
          grep -v "contract_example_test.go" > coverage_filtered.out || true

          # Use filtered coverage if it has content, otherwise keep original
          if [ -s coverage_filtered.out ]; then
            mv coverage_filtered.out coverage.out
            echo "âœ… Excluded test infrastructure from coverage"
          fi
      - name: Check coverage threshold
        run: |
          # Coverage Analysis:
          # - Client package: 99%+ (pure unit tests - full coverage)
          # - Provider non-CRUD code: 100% (factory, Configure, Metadata, Schema, mapping)
          # - Provider CRUD: 0% unit tests (tested via acceptance tests - TF framework limitation)
          # - Total: ~51% (reflects unit testable code, excluding test infrastructure)
          #
          # Note: CRUD operations (Create/Read/Update/Delete/ImportState) require TF Plugin
          # Framework fixtures to unit test. These are thoroughly tested via acceptance tests.
          #
          # Excluded from coverage: Test infrastructure helpers (contract_validators.go,
          # contract_test_helpers.go) - these are reusable test utilities, not production code.

          echo "=== Coverage Analysis ==="
          go tool cover -func=coverage.out | grep -E "total:"

          TOTAL_COVERAGE=$(go tool cover -func=coverage.out | grep "^total:" | awk '{print $3}' | tr -d '%')

          echo ""
          echo "Production code coverage: ${TOTAL_COVERAGE}%"
          echo ""
          echo "Coverage breakdown:"
          echo "  - Client API code: ~95%+ (comprehensive unit tests)"
          echo "  - Provider helpers/mapping: 100%"
          echo "  - Provider CRUD: tested via acceptance tests (TestAcc*)"
          echo "  - Test infrastructure: excluded from coverage"
          echo ""

          # Threshold: 50% (production code only, excluding test infrastructure)
          if [ $(echo "$TOTAL_COVERAGE < 50" | bc -l) -eq 1 ]; then
            echo "âŒ Coverage ${TOTAL_COVERAGE}% is below 50% threshold"
            exit 1
          fi
          echo "âœ… Production code coverage ${TOTAL_COVERAGE}% meets 50% threshold"
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@0565863a31f2c772f9f0395002a31e3f06189574 # v5.4.0
        with:
          files: ./coverage.out,./coverage_provider.out
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true

      # Run acceptance tests with parallel execution (only if API key available)
      - name: Run acceptance tests (E2E)
        if: env.HYPERPING_API_KEY != ''
        env:
          TF_ACC: "1"
          HYPERPING_API_KEY: ${{ secrets.HYPERPING_API_KEY }}
          # Optimize parallel execution for acceptance tests
          GOMAXPROCS: "4"
        run: |
          # Run with parallelism: -p 2 packages (limit API load), -parallel 10 tests per package
          # Timeout: 30m for comprehensive E2E testing
          go test -v -p 2 -parallel 10 -timeout 30m ./internal/provider/
        continue-on-error: false

      - name: Acceptance tests skipped (no API key)
        if: env.HYPERPING_API_KEY == ''
        env:
          HYPERPING_API_KEY: ${{ secrets.HYPERPING_API_KEY }}
        run: |
          echo "âš ï¸  Acceptance tests skipped - HYPERPING_API_KEY not available"
          echo "This is expected for:"
          echo "  - Pull requests from forks"
          echo "  - First-time contributors"
          echo ""
          echo "Unit and contract tests have passed. Maintainers will run acceptance tests."

  # API Sync Check - ensures provider matches documented API
  # This blocks PRs if the provider is out of sync with API documentation
  sync-check:
    name: API Sync Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_wrapper: false

      - name: Restore scraper snapshots
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            tools/cmd/scraper/.scraper_cache.json
            tools/cmd/scraper/snapshots/
            tools/cmd/scraper/docs_scraped/
          key: scraper-data-
          restore-keys: |
            scraper-data-

      - name: Build scraper
        working-directory: tools/cmd/scraper
        run: go build -o scraper

      - name: Check for snapshots
        id: check-snapshots
        working-directory: tools/cmd/scraper
        run: |
          if find ./snapshots -name "hyperping-api.yaml" -type f 2>/dev/null | grep -q .; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Snapshots found, proceeding with sync check"
            find ./snapshots -name "hyperping-api.yaml" | head -3
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No valid OAS snapshots found (directory may exist but contains no hyperping-api.yaml)"
            echo "Sync check will be skipped. Run the scraper workflow first to populate snapshots."
          fi

      - name: Generate provider schema
        if: steps.check-snapshots.outputs.found == 'true'
        run: |
          terraform -chdir=examples/complete providers schema -json > tools/cmd/scraper/schema.json 2>/dev/null || \
          terraform -chdir=. providers schema -json > tools/cmd/scraper/schema.json

      - name: Run sync check
        if: steps.check-snapshots.outputs.found == 'true'
        working-directory: tools/cmd/scraper
        run: |
          ./scraper -sync \
            -schema-file=./schema.json \
            -snapshot-dir=./snapshots

      - name: Sync check skipped notice
        if: steps.check-snapshots.outputs.found != 'true'
        run: |
          echo "::warning::Sync check skipped - no API snapshots available. Run 'API Documentation Scraper' workflow first."

